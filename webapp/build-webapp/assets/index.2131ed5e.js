import{e as re,j as e,O as ne,r as v,Q as k,f as D,M as X,C as se,R as W,S as I,U as oe,V as B,W as U,X as le,F as ie,l as N,Y as V,Z as O,$ as de,p as $,a0 as H,a1 as ce,a2 as ue,a3 as Y,a4 as q,a5 as me,a6 as ge,a7 as he,a8 as fe,h as pe,a9 as Ce,aa as ve,ab as Me,ac as ye,ad as xe,H as Te,ae as Se,af as Ve,ag as De,ah as be}from"./index.5bdb0a85.js";import{I as we,M as Ie}from"./index.c6ddb0c6.js";import Ne from"./MDTextField.f2d244c3.js";import"./RemoveSharp.5e061972.js";const Ee=re(e("path",{d:"M17.65 6.35C16.2 4.9 14.21 4 12 4c-4.42 0-7.99 3.58-7.99 8s3.57 8 7.99 8c3.73 0 6.84-2.55 7.73-6h-2.08c-.82 2.33-3.04 4-5.65 4-3.31 0-6-2.69-6-6s2.69-6 6-6c1.66 0 3.14.69 4.22 1.78L13 11h7V4l-2.35 2.35z"}),"RefreshSharp"),Oe=({onChange:a,value:g,label:d,error:c,...h})=>{var u;const[M,{data:f}]=ne.useLazyGetModelsOldQuery(),[p,n]=v.exports.useState(""),[s,l]=v.exports.useState(!1);v.exports.useEffect(()=>{M({q:"",page:0,perPage:15})},[]);const t=oe((r,o,b)=>{n(o),s||l(!0),M({q:o,perPage:10,page:0}).finally(()=>l(!1))});let i=(f==null?void 0:f.data)||[];return p&&(!((u=f==null?void 0:f.data)!=null&&u.length)||!f.data.map(r=>r.name).includes(p))&&(i=i.concat([{name:p,new:!0,loading:s}])),e(k,{loading:s,onInputChange:t,options:i,freeSolo:!0,onChange:(r,o,b)=>{!a||(b==="selectOption"?a(o||void 0):b==="clear"?a():b==="createOption"&&a({name:o}))},value:g!=null&&g.name?g:null,getOptionLabel:r=>(r==null?void 0:r.name)||"",renderOption:(r,o)=>D(X,{...r,children:[o.name,o.loading&&e(se,{sx:{ml:3,width:10,height:10}}),!(o!=null&&o.loading)&&o.new&&e(W,{color:"success",sx:{ml:3},label:"new"}),!(o!=null&&o.loading)&&!(o!=null&&o.new)&&e(W,{sx:{ml:3},label:"existing"})]}),isOptionEqualToValue:(r,o)=>(r==null?void 0:r.name)===(o==null?void 0:o.name),renderInput:r=>e(I,{error:c,...r,label:d}),...h})},Pe=({control:a})=>{const[g,d]=B(),{setValue:c}=U(),h=g.get("registeredModel"),[M,{data:f,isLoading:p}]=le(),n=()=>{d("",{replace:!0,state:{}})};return v.exports.useEffect(()=>{!f||f&&c("name",f.name)},[f]),D(ie,{children:[D(N,{sx:{display:"flex",flexDirection:"row",alignItems:"center"},"data-testid":"model-description-form",children:[e(V,{control:a,name:"name",rules:{required:{value:!0,message:"Model name field is required"}},render:({field:s,fieldState:l})=>{var t;return e(Oe,{"data-testid":"model-name",sx:{width:"100%"},error:!!l.error,label:((t=l.error)==null?void 0:t.message)||"Model Name",disabled:!!h,value:{name:s.value},onChange:i=>{s.onChange({target:{value:i==null?void 0:i.name}})},onBlur:s.onBlur,id:"model-name"})}}),h&&e(O,{variant:"text",onClick:n,children:"Clear"}),!h&&e(we,{"data-testid":"random-model-name",disabled:p,onClick:()=>M(),children:e(Ee,{})})]}),e(V,{control:a,name:"modelDescription",render:({field:s,fieldState:l})=>{var t;return e(I,{"data-testid":"model-description",...s,error:!!l.error,label:((t=l.error)==null?void 0:t.message)||"Model Description",sx:{width:"100%",mt:1}})}}),e(V,{control:a,name:"config.name",rules:{required:{value:!0,message:"Model version name is required"}},render:({field:s,fieldState:l})=>{var t;return e(I,{"data-testid":"version-name",...s,error:!!l.error,label:((t=l.error)==null?void 0:t.message)||"Model Version Name",sx:{width:"100%",mt:1}})}}),e(N,{"data-color-mode":"light",children:e(V,{name:"modelVersionDescription",render:({field:s,fieldState:l})=>{var t;return e(Ne,{previewOptions:{rehypePlugins:[[de]]},id:"description-input","data-testid":"version-description",...s,error:!!l.error,label:((t=l.error)==null?void 0:t.message)||"Model Version Description",onChange:i=>s.onChange({target:{value:i}})})}})})]})},Le=a=>{const{value:g}=a,[d,c]=v.exports.useState(g||null),h=$(n=>n.datasets.datasets),[M]=H(),f=h;v.exports.useEffect(()=>{g&&c(g)},[g]),v.exports.useEffect(()=>{h.length||M({page:0,perPage:50,searchByName:""})},[h]);const p=(n,s)=>{M({page:0,perPage:50,searchByName:s})};return e(k,{...a,sx:{mt:1},onBlur:a.onBlur,value:d,isOptionEqualToValue:(n,s)=>n.id===s.id,options:f,getOptionLabel:n=>n==null?void 0:n.name,noOptionsText:"No datasets",onInputChange:p,onChange:(n,s,l)=>{l==="selectOption"&&s&&typeof s!="string"&&(c(s),a.onChange&&a.onChange(s))},renderOption:(n,s)=>e("li",{...n,children:e(N,{children:s.name})}),renderInput:n=>e(I,{label:a.label||"Dataset",error:!!a.error,...n}),id:"dataset-select"})},Fe=a=>e(I,{...a}),j=a=>{const g=(d,c)=>{a.onChange(c)};return e("div",{"data-testid":a["data-testid"],children:e(k,{id:a.id,sx:{mt:1},multiple:a.multiple,title:a.label,onChange:g,value:a.value||(a.multiple?[]:null),options:a.options.sort((d,c)=>d.name.localeCompare(c.name)),onBlur:a.onBlur,renderInput:d=>e(Fe,{label:a.label,error:a.error,...d}),renderOption:(d,c)=>v.exports.createElement(X,{...d,key:c.name},c.name,e(ce,{sx:{ml:"auto"},...c.dataType})),getOptionLabel:d=>d.name,isOptionEqualToValue:(d,c)=>(d==null?void 0:d.name)===(c==null?void 0:c.name)})})},qe=({control:a})=>{const{setValue:g}=U(),[d]=ue(),[c]=H(),[h]=B(),M=Y({control:a,name:"config.dataset.name"}),f=$(t=>t.datasets.datasets.find(i=>i.name===M));v.exports.useEffect(()=>{!f&&M&&c({page:0,perPage:15,searchByName:M})},[]);const[p,n]=v.exports.useState(f),s=v.exports.useMemo(()=>((p==null?void 0:p.columnsMetadata)||[]).map(t=>({name:t.pattern,dataType:t.dataType})),[p]),l=h.get("datasetId");return v.exports.useEffect(()=>{if(!l)return;(async()=>{if(l){const i=parseInt(l);if(isNaN(i))return;const u=await d({datasetId:parseInt(l)});"data"in u&&u.data&&(n(u.data),g("config.dataset.name",u.data.name))}})()},[l]),D("div",{"data-testid":"dataset-config-form",children:[e(V,{control:a,name:"config.dataset.name",rules:{required:{value:!0,message:"Dataset is required"}},render:({field:t,fieldState:i})=>{var u;return e(Le,{"data-testid":"dataset-selector",value:p,onBlur:t.onBlur,error:!!i.error,label:((u=i.error)==null?void 0:u.message)||"Dataset",onChange:r=>{r?(t.onChange({target:{value:r.name}}),n(r)):(t.onChange({target:{value:void 0}}),n(void 0))}})}}),e(V,{control:a,name:"config.dataset.targetColumns",rules:{required:{value:!0,message:"A target column is required"}},render:({field:t,fieldState:i})=>{var u;return p?e(j,{id:"target-col","data-testid":"dataset-target-column",multiple:!0,onBlur:t.onBlur,error:!!i.error,value:t.value,onChange:r=>{t.onChange({target:{value:r}})},label:((u=i.error)==null?void 0:u.message)||"Target Column",options:s.filter(r=>q.isCategorical(r.dataType)||q.isNumerical(r.dataType)||q.isQuantity(r.dataType))}):e("div",{})}}),e(V,{control:a,name:"config.dataset.featureColumns",rules:{required:{value:!0,message:"The feature columns is required"},minLength:{value:1,message:"The feature columns must not be empty"}},render:({field:t,fieldState:i})=>{var u;return p?e(j,{onBlur:t.onBlur,error:!!i.error,id:"feature-cols","data-testid":"dataset-feature-columns",multiple:!0,value:t.value,onChange:r=>t.onChange({target:{value:r}}),label:((u=i.error)==null?void 0:u.message)||"Feature Column",options:s}):e("div",{})}})]})},Ge=()=>{const[a,g]=v.exports.useState(0),[d,{isLoading:c,data:h}]=me(),[M,f]=B(),{notifyError:p}=ge(),n=he({mode:"all",defaultValues:{name:"",modelDescription:"",modelVersionDescription:"",config:{name:"",dataset:{featureColumns:[],featurizers:[],targetColumns:[]},spec:{layers:[]}}}}),[s,{error:l,isLoading:t,data:i}]=fe(),{control:u,getValues:r,setValue:o}=n,b=Y({control:u,name:"config"}),Z=pe(),J=C=>{C.preventDefault(),n.handleSubmit(async m=>{const x=await d({trainingCheckRequest:{modelSpec:{framework:"torch",...m.config}}});if(!("error"in x)&&!x.data.stackTrace)return s({modelCreate:m}).then(S=>{"data"in S&&Z(`/models/${S.data.id}`)})},()=>{p("Error creating dataset")})()},z=(C,m)=>{var S,w;if(C<m)return g(C);let x;if(m===0){const T=r("name"),L=r("config.name");T?L||(x="Missing model version name"):x="Missing model name"}else if(m===1){const T=r("config.dataset");T!=null&&T.name?(S=T.targetColumns)!=null&&S.length?(w=T.featureColumns)!=null&&w.length||(x="Missing dataset feature columns selection"):x="Missing dataset target column selection":x="Missing dataset name"}x?p(x):g(C)},[K,{data:ke,isLoading:Be}]=Ce(),P=M.get("registeredModel");v.exports.useEffect(()=>{(async()=>{var R,Q,A,G,_;if(!P)return;const m=await K({modelId:parseInt(P)}).unwrap();n.setValue("name",m.name),n.setValue("modelDescription",m.description||""),n.setValue("config.dataset.name",((R=m==null?void 0:m.dataset)==null?void 0:R.name)||"");const x=m.columns.filter(y=>y.columnType==="feature"),S=m.columns.filter(y=>y.columnType==="target"),w=(A=(Q=m==null?void 0:m.dataset)==null?void 0:Q.columnsMetadata)==null?void 0:A.filter(y=>x.map(F=>F.columnName).includes(y.pattern)),T=(_=(G=m==null?void 0:m.dataset)==null?void 0:G.columnsMetadata)==null?void 0:_.filter(y=>S.map(F=>F.columnName).includes(y.pattern)),L=y=>({name:y.pattern,dataType:y.dataType}),te=y=>({name:y.pattern,dataType:y.dataType,outModule:""});w&&n.setValue("config.dataset.featureColumns",w.map(L)),T&&n.setValue("config.dataset.targetColumns",T.map(te))})()},[P]);const ee=()=>{const C=a-1;z(C,a)},ae=()=>{const C=a+1;z(C,a)},E=[{title:"Model Description",content:e(Pe,{control:u})},{title:"Features and Target",content:e(qe,{control:u})},{title:"Model Architecture",content:D(N,{sx:{maxWidth:"100vw"},children:[e("div",{children:e(Ie,{value:ve(b),onChange:C=>{o("config",C)}})}),(h==null?void 0:h.stackTrace)&&e(Me,{stackTrace:h==null?void 0:h.stackTrace,message:"An exception is raised during your model configuration for this dataset"})]})}];return e(ye,{children:e(xe,{children:e(Te,{children:e(Se,{...n,children:D("form",{style:{position:"relative",overflowX:"hidden"},children:[e(Ve,{orientation:"horizontal",activeStep:a,sx:{mb:5,mt:2},children:E.map(({title:C})=>e(De,{children:e(be,{children:C})},C))}),E[a].content,D(N,{sx:{mt:2,ml:3},children:[a!==0&&e(O,{onClick:ee,variant:"contained",sx:{mr:3},"data-testid":"previous",children:"PREVIOUS"}),a!==E.length-1&&e(O,{"data-testid":"next",onClick:ae,variant:"contained",children:"NEXT"}),a===E.length-1&&e(O,{variant:"contained",onClick:J,children:"CREATE"})]},"footer")]})})})})})};export{Ge as default};
