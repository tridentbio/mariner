import{e as ee,j as e,p as te,i as ae,r as I,a6 as H,bg as ne,Q as R,S as L,f as c,M as T,F as P,C as Z,R as E,U as se,bh as le,a4 as ie,W as q,b2 as re,aE as G,Y as w,bi as p,bj as F,aJ as oe,bk as de,bl as J,az as B,aK as ce,aL as me,l as A,m as ue,I as V,aZ as pe,bm as he,bn as ge,bo as fe,a7 as ye,ae as be,B as $,aV as xe,bp as ve,bq as K,br as Se,Z as z,b6 as Ce}from"./index.5bdb0a85.js";import{B as Te}from"./Badge.44cfa6d9.js";import{R as we}from"./RemoveSharp.5e061972.js";import{C as De}from"./Container.c76c626f.js";const Me=ee(e("path",{d:"M1 21h22L12 2 1 21zm12-3h-2v-2h2v2zm0-4h-2v-4h2v4z"}),"WarningOutlined"),Fe=()=>e(E,{sx:{ml:1},color:"primary",label:"valid unit"}),Ie=()=>e(E,{sx:{ml:1},color:"error",label:"invalid unit"}),W=({value:i,label:m,onChange:C,error:O,pattern:f})=>{const y=te(a=>a.units.units),D=ae(),[u,h]=I.exports.useState(!1),[b,x]=I.exports.useState(!1),{notifyError:M}=H();I.exports.useEffect(()=>{D(ne())},[]);const v=se(a=>{if(!a){h(!1);return}x(!0),le(a).then(h).catch(()=>{h(!1)}).finally(()=>x(!1))},500),U=I.exports.useMemo(()=>i&&y.map(a=>a.name).includes(i.name)?y:[{name:i==null?void 0:i.name,type:"raw"},...y],[y,i]);return e(R,{sx:{mt:2,width:"100%"},"data-testid":`dataset-col-data-type-unit-${f}`,renderInput:a=>e(L,{placeholder:"mole, meters, mole/litre, ...",label:"Unit",helperText:O||"",error:!!O,...a}),filterOptions:(a,r)=>(a.sort((l,d)=>l.name<d.name?1:-1),[...r.inputValue&&!a.map(l=>l.name).includes(r.inputValue)?[{name:r.inputValue,type:"raw"}]:[],...a.filter(l=>l.type==="raw"||l.name.toLowerCase().includes(r.inputValue.toLowerCase())).slice(0,100)]),renderOption:(a,r)=>c(T,{...a,children:[r.name,r.name&&c(P,{children:[r.type==="raw"&&b&&e(Z,{sx:{ml:1}}),r.type==="raw"&&!b&&u&&e(Fe,{}),r.type==="raw"&&!b&&!u&&e(Ie,{})]})]}),getOptionLabel:a=>(a==null?void 0:a.name)||"",options:U,value:i,onChange:(a,r)=>{if((r==null?void 0:r.type)==="raw"){if(b){M("Wait while we validate the unit");return}else if(!u){M('Unit is not parseble, compose valid units like "mol/litre", "volts*hour"');return}C&&C(r)}else C&&C(r)},onInputChange:(a,r)=>{v(r)},isOptionEqualToValue:(a,r)=>(a==null?void 0:a.name)===(r==null?void 0:r.name)})},j=i=>c(oe,{...i,onChange:m=>i.onChange&&i.onChange(m),value:i.value,children:[e(T,{value:p.Categorical,children:"Categorical"},p.Categorical),e(T,{value:p.Dna,children:"DNA"},p.Dna),e(T,{value:p.Numerical,children:"Numeric"},p.Numerical),e(T,{value:p.Protein,children:"Protein"},p.Protein),e(T,{value:p.Rna,children:"RNA"},p.Rna),e(T,{value:p.Smiles,children:"SMILES"},p.Smiles),e(T,{value:p.String,children:"String"},p.String)]}),Oe=({value:i,label:m,onChange:C,error:O,index:f,control:y,pattern:D,...u})=>{const[h,b]=I.exports.useState(i==null?void 0:i.domainKind),[x,M]=I.exports.useState(i&&ie.isQuantity(i)&&i.unit||""),U=q().watch(`columnsMetadata.${f}.dataType.domainKind`);return c(re,{sx:{width:"100%"},...u,children:[e(G,{id:"select-label",children:m}),f!==void 0?c(P,{children:[e(w,{control:y,name:`columnsMetadata.${f}.dataType.domainKind`,render:({field:a,fieldState:{error:r}})=>e(j,{...a,value:a.value||void 0,"data-testid":`data-type-input-${D}`,error:!!r,label:(r==null?void 0:r.message)||`Data Type ${f}`})}),U===p.Numerical&&e(w,{control:y,name:`columnsMetadata.${f}.dataType.unit`,rules:{...F},render:({field:a,formState:{errors:{columnsMetadata:r}},fieldState:{error:l}})=>{var d,g;return e(W,{pattern:D,error:(l==null?void 0:l.message)||r&&((g=(d=r[f])==null?void 0:d.dataType)==null?void 0:g.message),value:{name:a.value},onChange:S=>a.onChange({target:{value:(S==null?void 0:S.name)||""}})})}})]}):c(P,{children:[e(j,{label:"Data Type",onChange:a=>b(a.target.value),value:h,"data-testid":"dataset-col-data-type"}),e(W,{label:"Unit",value:{name:x},onChange:a=>M((a==null?void 0:a.name)||""),pattern:D})]})]})},Ue=({control:i,columnsMeta:m,error:C,label:O})=>{const{watch:f,getValues:y,register:D}=q(),{append:u,remove:h,fields:b}=de({control:i,name:"columnsMetadata"}),x=f("columnsMetadata"),M=l=>m.map(d=>d.name).some(d=>ge(d)(l)),v=l=>{if(x&&x.map(d=>d.pattern).filter(d=>d===l).length>1)return"Pattern already described";if(U(l)){if(!M(l))return"Doesn't match any column"}else return"Invalid regex"},U=l=>{try{return new RegExp(l),!0}catch{return!1}},a=x?m.map(l=>l.name).filter(J(x.map(l=>l.pattern))):[],r=l=>{h(l)};return c("div",{children:[e(B,{fontSize:20,fontWeight:"bold",mb:1,children:"Columns Descriptions:"}),C&&e(ce,{color:"error",icon:e(me,{}),children:O}),e(A,{sx:{mb:1},children:!!m.length&&e(A,{sx:{lineHeight:3,maxHeight:250,overflowY:"auto",pt:2,pb:2,pr:2,pl:2},children:m.map(l=>{const d=e(E,{sx:{mr:1},color:a.includes(l.name)?"default":"primary",label:l.name},l.name);return l.name.startsWith("Unnamed: ")?e(Te,{title:"Unnamed column from uploaded file",color:"warning",badgeContent:e(Me,{sx:{width:10,height:10}}),anchorOrigin:{vertical:"top",horizontal:"left"},children:d},l.name+"badge"):d})})}),c(A,{children:[e(B,{children:"Use a valid regular expression to describe a set of related column names."}),b.map(({pattern:l,id:d},g)=>c("div",{children:[c(A,{sx:{display:"flex",flexDirection:"row",alignItems:"center",mb:2,mt:2},children:[e(ue,{title:"Remove this column description",children:e(V,{onClick:()=>r(g),children:e(we,{})})}),c(A,{"data-testid":`input-group-${l}`,sx:{width:"100%",display:"flex",flexDirection:"column"},children:[e(w,{control:i,name:`columnsMetadata.${g}.pattern`,rules:{...F,validate:v},render:({field:S,fieldState:{error:t}})=>{const n={value:S.value,raw:!1,label:S.value};return e(R,{sx:{mt:1},selectOnFocus:!0,clearOnBlur:!0,handleHomeEndKeys:!0,options:a.map(s=>({label:s,value:s,raw:!1})).concat(l===""||a.some(s=>s.includes(l))?[]:[n]),onChange:(s,o)=>{S.onChange({target:{value:(o==null?void 0:o.value)||""}})},value:n,noOptionsText:"No columns",renderInput:s=>e(L,{error:!!t,helperText:t==null?void 0:t.message,label:"Column Name Pattern",placeholder:"col_pattern_*",onChange:o=>{S.onChange(o.target.value)},...s,"data-testid":"dataset-col-name-input"})})}}),e(L,{"data-testid":"dataset-col-description-input",defaultValue:y(`columnsMetadata.${g}.description`),...D(`columnsMetadata.${g}.description`),"data-descriptionPattern":`${l}`,sx:{mt:1},multiline:!0,label:`Description ${g+1}`,type:"standard"}),e(A,{sx:{width:"100%",mt:1},children:e(Oe,{pattern:l,label:`Data Type ${g+1}`,index:g,control:i})})]})]}),e(pe,{})]},d))]}),!!a.length&&b.length<m.length&&e(V,{title:"Add a column description",color:"primary",onClick:()=>u({pattern:"",description:"",dataType:{domainKind:p.String}}),id:"add-col-description",children:e(he,{})})]})},{useGetColumnsMetadataMutation:Le}=Ce,Ae=I.exports.lazy(()=>fe(()=>import("./MDTextField.f2d244c3.js"),["assets/MDTextField.f2d244c3.js","assets/index.5bdb0a85.js","assets/index.32ed364a.css"])),N={sx:{mb:1}},Pe=i=>i||{name:"",description:"",splitType:K.random,splitTarget:"",columnsMetadata:[]},Re=({initialValues:i,...m})=>{var g,S;const C=ye({defaultValues:Pe(i)}),{handleSubmit:O,getValues:f,reset:y,watch:D,control:u,formState:{errors:h}}=C,b=D("splitType"),[x,{isLoading:M}]=Le(),[v,U]=I.exports.useState((g=i==null?void 0:i.columnsMetadata)==null?void 0:g.map(({pattern:t,dataType:n,description:s})=>({name:t,dtype:n,description:s}))),{setMessage:a}=H(),r=O(t=>{if(m.onSubmit)return m.onSubmit({columnsMetadata:JSON.stringify(t.columnsMetadata),name:t.name,description:t.description,splitType:t.splitType,splitTarget:t.splitTarget,file:t.file,splitOn:t.splitOn})},t=>{a({message:"Failed to submit dataset",type:"error"})}),l=async(t,n=20)=>{const s=new FileReader;return s.readAsText(t),new Promise((o,Q)=>{s.onload=async _=>{var k;const X=(((k=_.target)==null?void 0:k.result)||"").split(`
`,n).join(`
`),Y=new File([X],t.name||"file.csv",{type:"text/plain"});o(Y)},s.onerror=_=>Q(_)})},d=async t=>{try{const s=await x(t.size>1e6?await l(t):t).then(o=>{if("data"in o&&o.data)return o.data;throw new Error("Failed to get csv columns")});U(s),y({...f(),columnsMetadata:s.filter(o=>o.dtype).map(o=>({pattern:`${o.name}`,dataType:o.dtype,description:""}))})}catch{a({type:"error",message:"Failed to get csv columns"})}};return e(be,{...C,children:e("form",{autoComplete:"off",onSubmit:r,children:c($,{sx:{m:1,display:"flex",flexDirection:"column"},children:[e(w,{rules:{...F},shouldUnregister:!0,name:"name",control:u,render:({field:t,fieldState:{error:n}})=>e(L,{label:"Name",helperText:n==null?void 0:n.message,id:"dataset-name-input",error:!!h.name,...N,...t})}),e(w,{name:"description",rules:{...F},control:u,render:({field:t,fieldState:{error:n}})=>e(Ae,{error:!!n,...t,onChange:s=>t.onChange({target:{value:s}}),label:"Description",helperText:n==null?void 0:n.message})}),!i&&c($,{sx:{mb:1.5},children:[e(w,{rules:{...F},control:u,name:"file",render:({field:t,fieldState:{error:n}})=>c(P,{children:[e(G,{htmlFor:"dataset-upload",error:!!n,children:"File"}),e("input",{type:"file",id:"dataset-upload",onChange:s=>{s.target.files&&s.target.files.length&&(t.onChange({target:{value:s.target.files[0]}}),d(s.target.files[0]))},accept:".csv"})]})}),!!h.file&&e(xe,{error:!0,children:((S=h.file)==null?void 0:S.message)||""})]}),e(ve,{isLoading:M,message:"Wait while we check the data types of your dataset"}),v&&c(P,{children:[e(w,{rules:{...F},name:"splitType",render:({field:t})=>{var n;return c(L,{disabled:!!i,label:"Split Type",sx:{mb:1},id:"dataset-splittype-input",helperText:((n=h.splitType)==null?void 0:n.message)||"Stratagy used to split the dataset",select:!0,error:!!h.splitType,...t,children:[e(T,{value:K.random,children:"Random"}),v.some(s=>{var o;return((o=s.dtype)==null?void 0:o.domainKind)==="smiles"})&&e(T,{value:K.scaffold,children:"Scaffold"})]})},control:u}),b==="scaffold"?e(w,{control:u,rules:{...F},name:"splitOn",render:({field:t})=>e(R,{onChange:(n,s)=>t.onChange((s==null?void 0:s.name)||""),onBlur:t.onBlur,ref:t.ref,id:"dataset-split-column-input",renderInput:n=>{var s;return e(L,{label:"Split on",helperText:((s=h.splitOn)==null?void 0:s.message)||"",error:!!h.splitOn,...N,...n,disabled:!!i})},value:v.find(n=>n.name===t.value),getOptionLabel:n=>n.name,options:v.filter(n=>{var s;return((s=n.dtype)==null?void 0:s.domainKind)==="smiles"})})}):null,e(w,{name:"splitTarget",shouldUnregister:!0,control:u,rules:{...F,validate:{value:t=>{if(typeof t=="string"){const n=t.split("-");if(n.length!==3)return"Should be a valid split division, e.g.: 60-20-20, 80-10-10";const s=n.map(o=>parseInt(o));if(s.includes(NaN))return"Should only have ints";if(Se(s)!==100)return"Should sum up to 100"}}}},render:({field:t,fieldState:{error:n}})=>e(L,{label:"Split",helperText:(n==null?void 0:n.message)||"Training-Testing-Validation %s",error:!!n,placeholder:"60-20-20",id:"dataset-split-input",...N,...t,disabled:!!i})}),e(w,{control:u,name:"columnsMetadata",rules:{validate:t=>{const n=v.filter(s=>J((t||[]).map(o=>o.pattern))(s.name));if(n.length)return"Some columns are not described: "+n.map(s=>s.name).join(", ")}},render:({fieldState:{error:t}})=>{var n;return e(P,{children:e(Ue,{error:!!(t!=null&&t.root),label:(n=t==null?void 0:t.root)==null?void 0:n.message,columnsMeta:v,control:u})})}})]}),c(De,{sx:{display:"flex",flexDirection:"row",justifyContent:"flex-end",mt:3},children:[e(z,{onClick:m.onCancel,children:"Close"}),e($,{sx:{position:"relative",ml:5},children:c(z,{type:"submit",variant:"contained",color:"primary",disabled:m.loading,id:"save",children:["Save",m.loading&&e(Z,{size:30,sx:{position:"absolute"}})]})})]})]})})})};export{Re as D};
