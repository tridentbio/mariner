name: test

on:
  push:
    branches: [ develop ]
  pull_request:
    branches: [ develop ]

jobs:
  test:
    runs-on: ubuntu-latest

    services:
      db:
        image: postgres
        ports:
          - "5432:5432"
        env:
          POSTGRES_SERVER: localhost
          POSTGRES_PASSWORD: 123456
          POSTGRES_USER: postgres
          POSTGRES_DB: app
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
      mlflowdb:
        image: postgres
        ports:
          - "54321:5432"
        env:
          POSTGRES_SERVER: localhost
          POSTGRES_PASSWORD: 123456
          POSTGRES_USER: postgres
          POSTGRES_DB: app
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
      mlflow:
        image: larribas/mlflow
        env:
          POSTGRES_SERVER: localhost
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: 123456
          POSTGRES_DB: app
          POSTGRES_PORT: 54321
        ports:
          - "5000:5000"
    steps:
      #----------------------------------------------
      # check-out repo and set-up python
      #----------------------------------------------
      - name: Check out repository
        uses: actions/checkout@v2
      - name: Set up python
        id: setup-python
        uses: actions/setup-python@v2
        with:
          python-version: 3.9
      #----------------------------------------------
      # install & configure poetry  -----
      #----------------------------------------------
      - name: Install Poetry
        uses: snok/install-poetry@v1
        with:
          virtualenvs-create: true
          virtualenvs-in-project: true
          installer-parallel: true

      #----------------------------------------------
      # load cached venv if cache exists
      #----------------------------------------------
      - name: Load cached venv
        id: cached-poetry-dependencies
        uses: actions/cache@v2
        with:
          path: .venv
          key: venv-${{ runner.os }}-${{ steps.setup-python.outputs.python-version }}-${{ hashFiles('**/poetry.lock') }}
      #----------------------------------------------
      # install dependencies if cache does not exist
      #----------------------------------------------
      - name: Install dependencies
        working-directory: ./app
        if: steps.cached-poetry-dependencies.outputs.cache-hit != 'true'
        run: poetry install --no-interaction --no-root
      #----------------------------------------------
      # install your root project, if required
      #----------------------------------------------
      - name: Install library
        working-directory: ./app
        run: |
          poetry install --no-interaction && \
          poetry run install_deps_cpu
      #----------------------------------------------
      # run migrations
      #----------------------------------------------
      - name: Run migrations
        working-directory: ./app
        run: |
          poetry run alembic upgrade head
          poetry run initial_data
        env:
          POSTGRES_SERVER: localhost
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: 123456
          POSTGRES_DB: app
      #----------------------------------------------
      # run test suite
      #----------------------------------------------
      - name: Run tests
        working-directory: ./app
        run: |
          source .venv/bin/activate
          pytest app/tests
          coverage report
        env:
          SERVER_NAME: localhost
          SERVER_HOST: http://localhost
          SENTRY_DSN: ''
          AWS_SECRET_KEY_ID: none
          AWS_SECRET_KEY: none
          DOMAIN: localhost
          STACK_NAME: mariner-trident-bio
          BACKEND_CORS_ORIGINS: '["http://localhost", "http://localhost:4200", "http://localhost:3000", "http://localhost:8080", "https://localhost", "https://localhost:4200", "https://localhost:3000", "https://localhost:8080", "http://dev.mariner.trident.bio", "https://stag.mariner.trident.bio", "https://mariner.trident.bio", "http://local.dockertoolbox.tiangolo.com", "http://localhost.tiangolo.com"]'
          PROJECT_NAME: mariner
          SECRET_KEY: 17a0be0cc06b63120770c707f14529c28d9af8d201523d022614f67eb04d8ec7
          FIRST_SUPERUSER: admin@mariner.trident.bio
          FIRST_SUPERUSER_PASSWORD: 123456
          SMTP_TLS: True
          SMTP_PORT: 587
          SMTP_HOST: smtp.gmail.com
          SMTP_USER: admin@mariner.trident.bio
          SMTP_PASSWORD: 12345
          EMAILS_FROM_EMAIL: info@mariner.trident.bio
          USERS_OPEN_REGISTRATION: False
          # Postgres
          POSTGRES_SERVER: localhost
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: 123456
          POSTGRES_DB: app
          MLFLOW_TRACKING_URI: http://localhost:5000
